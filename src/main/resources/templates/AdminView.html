<!DOCTYPE html>
<html lang="en"
      layout:decorate="~{Layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title layout:fragment="title">Admin Dashboard - CineTalk</title>
</head>

<th:block layout:fragment="content">
    <main class="admin-page">
        <div class="container">

            <div class="admin-header">
                <h1 class="hero-heading">
                    Admin <span class="hero-gradient">Dashboard</span>
                </h1>
                <p class="hero-subtitle">
                    Manage users and monitor forum activity
                </p>
            </div>


            <section class="admin-stats-grid">
                <div class="card admin-stat-card">
                    <div class="admin-stat-content">
                        <div class="admin-stat-label">Total Users</div>
                        <div class="admin-stat-value" th:text="${stats.totalUsers}">1,234</div>
                        <div class="admin-stat-change">Active community</div>
                    </div>
                </div>

                <div class="card admin-stat-card">
                    <div class="admin-stat-content">
                        <div class="admin-stat-label">Total Posts</div>
                        <div class="admin-stat-value" th:text="${stats.totalPosts}">5,678</div>
                        <div class="admin-stat-change">Growing daily</div>
                    </div>
                </div>

                <div class="card admin-stat-card">
                    <div class="admin-stat-content">
                        <div class="admin-stat-label">Total Comments</div>
                        <div class="admin-stat-value" th:text="${stats.totalComments}">12,345</div>
                        <div class="admin-stat-change">Engaged users</div>
                    </div>
                </div>

                <div class="card admin-stat-card">
                    <div class="admin-stat-content">
                        <div class="admin-stat-label">Blocked Users</div>
                        <div class="admin-stat-value" th:text="${stats.blockedUsers}">23</div>
                        <div class="admin-stat-change admin-stat-change--neutral">Moderated</div>
                    </div>
                </div>
            </section>


            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Users Management</div>
                        <div class="card-subtitle">Search by username, email, or first name</div>
                    </div>
                </div>


                <form id="user-filter-form" method="get" th:action="@{/admin}">
                    <div class="folder-toolbar">
                        <div class="folder-toolbar-left">
                            <span class="card-title">Users:</span>
                            <span class="folder-toolbar-meta">
                                Showing
                                <span th:text="${pageInfo.fromItem}">1</span>â€“<span
                                    th:text="${pageInfo.toItem}">10</span>
                                of
                                <span th:text="${pageInfo.totalItems}">1,234</span>
                            </span>
                        </div>
                        <div class="folder-toolbar-right">

                            <input type="text"
                                   name="search"
                                   class="folder-select admin-search-input"
                                   placeholder="Search users..."
                                   th:value="${searchQuery}"/>


                            <select name="status" class="folder-select">
                                <option value="">All Status</option>
                                <option value="active" th:selected="${statusFilter == 'active'}">Active</option>
                                <option value="blocked" th:selected="${statusFilter == 'blocked'}">Blocked</option>
                                <option value="admin" th:selected="${statusFilter == 'admin'}">Admin</option>
                            </select>


                            <select name="sort" class="folder-select">
                                <option value="username" th:selected="${sortBy == 'username'}">Sort by Username</option>
                                <option value="email" th:selected="${sortBy == 'email'}">Sort by Email</option>
                                <option value="firstName" th:selected="${sortBy == 'firstName'}">Sort by First Name
                                </option>
                            </select>


                            <select name="direction" class="folder-select">
                                <option value="asc" th:selected="${sortDirection == 'asc'}">ASC</option>
                                <option value="desc" th:selected="${sortDirection == 'desc'}">DESC</option>
                            </select>


                            <input type="hidden" name="page" th:value="${pageInfo.page}" id="page-input"/>
                        </div>
                    </div>
                </form>


                <div class="topic-list">

                    <article class="topic admin-user-topic"
                             th:each="user : ${users}"
                             th:classappend="${user.blocked} ? 'admin-user-topic--blocked' : ''">

                        <div class="admin-user-info-section">
                            <div class="admin-user-header">

                                <div class="admin-user-avatar"
                                     th:text="${#strings.substring(user.firstName, 0, 1).toUpperCase()}">J
                                </div>
                                <div class="admin-user-details">

                                    <a th:href="@{/profile/{username}(username=${user.username})}"
                                       class="admin-username-link">
                                        <span th:text="${user.username}">john_doe</span>
                                        <svg class="admin-external-link-icon" xmlns="http://www.w3.org/2000/svg"
                                             width="14" height="14" viewBox="0 0 24 24" fill="none"
                                             stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                             stroke-linejoin="round">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                            <polyline points="15 3 21 3 21 9"></polyline>
                                            <line x1="10" y1="14" x2="21" y2="3"></line>
                                        </svg>
                                    </a>
                                    <div class="topic-meta">
                                        <span th:text="${user.firstName + ' ' + user.lastName}">John Doe</span>
                                        <span>Â·</span>
                                        <span th:text="${user.email}">john.doe@example.com</span>
                                    </div>
                                </div>
                            </div>
                            <div class="admin-user-meta">
                                <span>Joined <span th:text="${#temporals.format(user.createdAt, 'MMM dd, yyyy')}">Jan 15, 2025</span></span>
                                <span><span th:text="${#lists.size(user.posts)}">42</span> posts</span>
                                <span th:if="${user.blocked}" class="badge badge-danger">Blocked</span>
                                <span th:unless="${user.blocked}" class="badge badge-success">Active</span>
                                <span th:if="${user.admin}" class="badge badge-admin">Admin</span>
                                <span th:unless="${user.admin}" class="badge badge-secondary">User</span>
                            </div>
                        </div>


                        <div class="admin-user-actions-compact">

                            <form th:if="${!user.blocked}"
                                  th:action="@{/admin/users/{id}/block(id=${user.id})}"
                                  method="post"
                                  class="admin-action-form"
                                  onsubmit="return confirm('Are you sure you want to block this user?');">
                                <input type="hidden" name="search" th:value="${searchQuery}"/>
                                <input type="hidden" name="status" th:value="${statusFilter}"/>
                                <input type="hidden" name="sort" th:value="${sortBy}"/>
                                <input type="hidden" name="direction" th:value="${sortDirection}"/>
                                <input type="hidden" name="page" th:value="${pageInfo.page}"/>
                                <button type="submit" class="btn btn-ghost btn-sm">Block</button>
                            </form>
                            <form th:if="${user.blocked}"
                                  th:action="@{/admin/users/{id}/unblock(id=${user.id})}"
                                  method="post"
                                  class="admin-action-form"
                                  onsubmit="return confirm('Are you sure you want to unblock this user?');">
                                <input type="hidden" name="search" th:value="${searchQuery}"/>
                                <input type="hidden" name="status" th:value="${statusFilter}"/>
                                <input type="hidden" name="sort" th:value="${sortBy}"/>
                                <input type="hidden" name="direction" th:value="${sortDirection}"/>
                                <input type="hidden" name="page" th:value="${pageInfo.page}"/>
                                <button type="submit" class="btn btn-ghost btn-sm">Unblock</button>
                            </form>


                            <form th:if="${!user.admin && !user.blocked}"
                                  th:action="@{/admin/users/{id}/promote(id=${user.id})}"
                                  method="post"
                                  class="admin-action-form"
                                  onsubmit="return confirm('Are you sure you want to promote this user to admin?');">
                                <input type="hidden" name="search" th:value="${searchQuery}"/>
                                <input type="hidden" name="status" th:value="${statusFilter}"/>
                                <input type="hidden" name="sort" th:value="${sortBy}"/>
                                <input type="hidden" name="direction" th:value="${sortDirection}"/>
                                <input type="hidden" name="page" th:value="${pageInfo.page}"/>
                                <button type="submit" class="btn btn-primary btn-sm">Make Admin</button>
                            </form>
                        </div>
                    </article>
                </div>


                <div th:if="${#lists.isEmpty(users)}" class="admin-empty-state">
                    <div class="admin-empty-icon">ðŸ‘¥</div>
                    <h3 class="admin-empty-title">No users found</h3>
                    <p class="admin-empty-text">Try adjusting your search or filters</p>
                </div>


                <div id="pagination-data"
                     th:data-total-pages="${pageInfo.totalPages}"
                     th:data-current-page="${pageInfo.page}"
                     class="pagination-data-hidden"></div>


                <div class="folder-pagination" th:if="${!#lists.isEmpty(users)}">
                    <button class="btn btn-ghost folder-page-btn"
                            id="prev-page-btn"
                            th:disabled="${pageInfo.page == 1}">â€¹ Prev
                    </button>

                    <span class="folder-page-info">
                        Page <span th:text="${pageInfo.page}">1</span>
                        of <span th:text="${pageInfo.totalPages}">124</span>
                    </span>

                    <button class="btn btn-ghost folder-page-btn"
                            id="next-page-btn"
                            th:disabled="${pageInfo.page == pageInfo.totalPages}">Next â€º
                    </button>
                </div>
            </section>
        </div>
    </main>
</th:block>


<th:block layout:fragment="scripts">
    <script>
        $(document).ready(function () {
            var form = $('#user-filter-form');
            var paginationData = $('#pagination-data');


            var totalPages = parseInt(paginationData.data('total-pages')) || 1;
            var currentPage = parseInt(paginationData.data('current-page')) || 1;


            $(form).find('select').on('change', function () {
                $('#page-input').val(1);
                $(form).submit();
            });

            // Search on Enter key
            $(form).find('input[name="search"]').on('keypress', function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $('#page-input').val(1);
                    $(form).submit();
                }
            });


            $('#prev-page-btn').on('click', function (e) {
                e.preventDefault();
                var currentPage = parseInt($('#page-input').val());
                if (currentPage > 1) {
                    $('#page-input').val(currentPage - 1);
                    $(form).submit();
                }
            });


            $('#next-page-btn').on('click', function (e) {
                e.preventDefault();
                var currentPage = parseInt($('#page-input').val());
                if (currentPage < totalPages) {
                    $('#page-input').val(currentPage + 1);
                    $(form).submit();
                }
            });
        });
    </script>
</th:block>
</html>