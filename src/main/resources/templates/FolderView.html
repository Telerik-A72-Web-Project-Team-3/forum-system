<!DOCTYPE html>
<html lang="en"
      layout:decorate="~{Layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:sec="http://www.w3.org/1999/xhtml">

<head>
    <title>View posts</title>
</head>

<section layout:fragment="content">
    <main class="folder-page">
        <div class="container">
            <!-- Breadcrumb & header -->
            <div class="folder-breadcrumb">
                <span th:each="pathFolder, i: ${folder.pathFolders}">
                    <span th:if="${i.index > 0}">‚Ä∫</span>
                    <a th:href="@{/path/{path}(path=${pathFolder.path})}"
                       th:text="${pathFolder.name}">Folder name</a>
                </span>
            </div>

            <div class="folder-header-row">
                <div>
                    <h1 class="folder-title" th:text="${folder.name}">TV Shows</h1>
                    <div class="folder-meta">
                        <span th:if="${parent != null}">Subfolder of <strong th:text="${parent.name}"></strong></span>
                        <span th:if="${parent != null}">¬∑</span>
                        <span th:text="${folder.folderCount} + ' topics ¬∑ ' + ${folder.postCount} + ' posts'">21 topics ¬∑ 184 posts</span>
                        <span>¬∑</span>
                        <span>Last activity <span th:text="${folder.lastActivity}"></span></span>
                    </div>
                </div>
                <div class="folder-header-actions" sec:authorize="isAuthenticated()">
                    <a class="btn btn-ghost" sec:authorize="hasRole('MODERATOR')"
                       th:href="@{/folders/new(folderId=${folder.id})}"
                       type="button">New folder</a>
                    <a class="btn btn-ghost" sec:authorize="hasRole('MODERATOR')"
                       th:href="@{/folders/{id}/edit(id=${folder.id})}"
                       type="button">Edit this folder</a>
                    <form method="post" onsubmit="return confirm('Are you sure you want to delete this folder? This action cannot be undone.');"
                          sec:authorize="hasRole('MODERATOR')"
                          th:action="@{/folders/{id}/delete(id=${folder.id})}">
                        <button class="btn btn-danger" type="submit">Delete folder</button>
                    </form>
                    <a class="btn btn-primary" th:href="@{/forum/posts/new(folderId=${folder.id})}"
                       type="button">New topic</a>
                </div>
            </div>

            <div class="folder-layout">
                <!-- LEFT: folder info + tree -->
                <aside class="card folder-sidebar">
                    <div class="folder-sidebar-section">
                        <div class="card-title">Folder details</div>
                        <div class="card-subtitle" th:text="${folder.description}">
                        </div>
                        <!-- Media metadata (only if present) -->
                        <div class="media-meta" th:if="${folder.metaData != null}">
                            <div class="media-meta-top">
                                <img class="media-meta-poster"
                                     th:alt="${folder.metaData.title}"
                                     th:if="${folder.metaData.poster != null and folder.metaData.poster != 'N/A'}"
                                     th:src="${folder.metaData.poster}"/>

                                <div class="media-meta-text">
                                    <div class="media-meta-title" th:text="${folder.metaData.title}">Title</div>

                                    <div class="media-meta-badges">
                                        <span class="badge" th:if="${folder.metaData.year != null}"
                                              th:text="${folder.metaData.year}">2020</span>
                                        <span class="badge" th:if="${folder.metaData.type != null}"
                                              th:text="${folder.metaData.type}">series</span>
                                    </div>

                                    <div class="media-meta-line"
                                         th:if="${folder.metaData.imdbRating != null}">
                                        ‚≠ê <span th:text="${folder.metaData.imdbRating}">8.7</span>/10
                                    </div>

                                    <div class="media-meta-line"
                                         th:if="${folder.metaData.genres != null}">
                                        <span th:text="${folder.metaData.genres}">Drama, Sci-Fi</span>
                                    </div>

                                    <div class="media-meta-line"
                                         th:if="${folder.metaData.country != null or folder.metaData.language != null}">
                                        <span th:if="${folder.metaData.country != null}"
                                              th:text="${folder.metaData.country}">USA</span>
                                        <span th:if="${folder.metaData.country != null and folder.metaData.language != null}"> ¬∑ </span>
                                        <span th:if="${folder.metaData.language != null}"
                                              th:text="${folder.metaData.language}">English</span>
                                    </div>
                                </div>
                            </div>

                            <div class="media-meta-plot"
                                 th:if="${folder.metaData.plot != null and folder.metaData.plot != 'N/A'}"
                                 th:text="${folder.metaData.plot}">
                                Plot‚Ä¶
                            </div>
                        </div>

                        <div class="folder-stats">
                            <div class="folder-stat-item" th:if="${folder.folderCount > 0}">
                                <span class="folder-stat-label">Subfolders</span>
                                <span class="folder-stat-value" th:text="${folder.folderCount}">21</span>
                            </div>
                            <div class="folder-stat-item">
                                <span class="folder-stat-label">Posts</span>
                                <span class="folder-stat-value" th:text="${folder.postCount}">184</span>
                            </div>
                        </div>
                    </div>

                    <!-- PARENT FOLDER (one level up) -->
                    <div class="folder-sidebar-section" th:if="${parent != null}">
                        <div class="card-title" style="margin-bottom:0.3rem;">Parent folder</div>

                        <div class="folder-parent">
                            <a class="folder-parent-link"
                               th:href="@{/path/{path}(path=${parent.path})}">
                                <span class="folder-node-icon">‚¨Ö</span>
                                <span class="folder-node-name" th:text="${parent.name}">TV Shows</span>
                            </a>
                            <div class="folder-parent-meta"
                                 th:text="${parent.postCount} + ' topics'">
                                21 topics
                            </div>
                        </div>
                    </div>

                    <!-- CURRENT FOLDER + SIBLINGS -->
                    <div class="folder-sidebar-section">
                        <div class="card-title" style="margin-bottom:0.3rem;">This level</div>
                        <ul class="folder-tree folder-tree--siblings">
                            <!-- Current folder -->
                            <li class="folder-node folder-node--active">
                                <a th:href="@{/path/{path}(path=${folder.path})}">
                                    <span class="folder-node-icon">üìÇ</span>
                                    <span class="folder-node-name" th:text="${folder.name}">Sci-Fi &amp; Fantasy</span>
                                    <span class="folder-node-count"
                                          th:text="${folder.postCount} + ' topics'">9 topics</span>
                                </a>
                            </li>

                            <!-- Siblings (same parent) -->
                            <li class="folder-node" th:each="sibling : ${siblingFolders}">
                                <a th:href="@{/path/{path}(path=${sibling.path})}">
                                    <span class="folder-node-icon">üìÇ</span>
                                    <span class="folder-node-name" th:text="${sibling.name}">Drama</span>
                                    <span class="folder-node-count"
                                          th:text="${sibling.postCount} + ' topics'">8 topics</span>
                                </a>
                            </li>
                        </ul>

                        <div class="folder-pagination" th:if="${siblingTotalPages > 1}">
                            <button class="btn btn-ghost folder-page-btn sibling-page-btn"
                                    data-delta="-1"
                                    th:disabled="${siblingPage == 1}"
                                    type="button">
                                ‚Äπ Prev
                            </button>

                            <span class="folder-page-info"
                                  th:text="'Page ' + ${siblingPage} + ' of ' + ${siblingTotalPages}">
                                Page 1 of 3
                            </span>

                            <button class="btn btn-ghost folder-page-btn sibling-page-btn"
                                    data-delta="1"
                                    th:disabled="${siblingPage == siblingTotalPages}"
                                    type="button">
                                Next ‚Ä∫
                            </button>
                        </div>

                    </div>

                    <!-- CHILDREN OF CURRENT FOLDER -->
                    <div class="folder-sidebar-section"
                         th:if="${childFolders != null and !#lists.isEmpty(childFolders)}">
                        <div class="card-title" style="margin-bottom:0.3rem;">Subfolders</div>

                        <ul class="folder-tree folder-tree--children">
                            <li class="folder-node" th:each="child : ${childFolders}">
                                <a th:href="@{/path/{path}(path=${child.path})}">
                                    <span class="folder-node-icon">üìÅ</span>
                                    <span class="folder-node-name" th:text="${child.name}">Star Wars</span>
                                    <span class="folder-node-count"
                                          th:text="${child.postCount} + ' topics'">4 topics</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="folder-pagination" th:if="${childTotalPages > 1}">
                        <button class="btn btn-ghost folder-page-btn child-page-btn"
                                data-delta="-1"
                                th:disabled="${childPage == 1}"
                                type="button">
                            ‚Äπ Prev
                        </button>

                        <span class="folder-page-info"
                              th:text="'Page ' + ${childPage} + ' of ' + ${childTotalPages}">
                            Page 1 of 3
                        </span>

                        <button class="btn btn-ghost folder-page-btn child-page-btn"
                                data-delta="1"
                                th:disabled="${childPage == childTotalPages}"
                                type="button">
                            Next ‚Ä∫
                        </button>
                    </div>


                </aside>

                <!-- RIGHT: posts list in this folder -->
                <section class="card folder-posts">

                    <form id="navigation-form" method="get" th:action="'/path' + ${path}">
                        <input name="siblingPage" th:value="${siblingPage}" type="hidden">
                        <input name="childPage" th:value="${childPage}" type="hidden">
                        <div th:replace="~{PostFilterFragment:: post-filter(
                            tags=${null},
                            pageInfo=${pageInfo},
                            tagId=${tagId},
                            orderBy=${orderBy},
                            direction=${direction})}">
                        </div>

                    </form>

                    <div class="topic-list">
                        <!-- Topics -->
                        <a th:replace="~{PostPreviewFragment:: post-preview(posts=${posts})}"></a>
                    </div>

                    <div th:replace="~{PostFilterFragment :: post-filter-buttons(pageInfo=${pageInfo})}"></div>
                </section>
            </div>
        </div>
    </main>
</section>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        var form = $('#navigation-form');

        // existing logic
        $(form).find('select').on('change', function () {
            $(this).closest('form').submit();
        });
        $('#prev-page-btn').on('click', function () {
            $(form).find('select[name=page]')
                .val(parseInt($(form).find('select[name=page]').val()) - 1);
            $(form).submit();
        });
        $('#next-page-btn').on('click', function () {
            $(form).find('select[name=page]')
                .val(parseInt($(form).find('select[name=page]').val()) + 1);
            $(form).submit();
        });

        // NEW: sibling pagination
        $('.sibling-page-btn').on('click', function () {
            var delta = parseInt($(this).data('delta'));
            var input = $(form).find('input[name=siblingPage]');
            var current = parseInt(input.val() || '1');
            input.val(current + delta);
            form.submit();
        });

        // NEW: child pagination
        $('.child-page-btn').on('click', function () {
            var delta = parseInt($(this).data('delta'));
            var input = $(form).find('input[name=childPage]');
            var current = parseInt(input.val() || '1');
            input.val(current + delta);
            form.submit();
        });
    </script>
</th:block>
</html>