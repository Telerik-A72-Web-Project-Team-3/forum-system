<!DOCTYPE html>
<html lang="en"
      layout:decorate="~{Layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>View post</title>
</head>

<section layout:fragment="content">
    <!-- MAIN CONTENT -->
    <main class="post-page">
        <div class="container">
            <div class="post-layout">
                <!-- MAIN COLUMN -->
                <section class="card post-card">
                    <header class="post-header">
                        <div class="post-label-row">
                            <span class="pill" th:each="tag: ${tags}" th:text="${tag.name}"></span>
                        </div>
                        <h1 class="post-title" th:text="${post.title}"></h1>
                        <div class="post-meta">
                            <span>Started by <strong th:text="${post.creator}"></strong></span>
                            <span>·</span>
                            <span>Posted <span th:text="${post.createdAtString}"></span></span>
                            <span>·</span>
                            <span>
                                <span th:text="${post.commentsCount}"></span>
                                replies ·
                                <span th:text="${post.views}"></span> views
                            </span>
                        </div>
                    </header>

                    <article class="post-body">
                        <p th:text="${post.content}"></p>
                    </article>

                    <div class="post-actions" sec:authorize="isAuthenticated()">
                        <a class="btn btn-ghost" th:href="@{/forum/posts/{postId}/edit(postId=${post.id})}"
                           th:if="${canEdit != null && canEdit && !post.deleted}">Edit</a>
                        <form method="post" onsubmit="return confirm('Are you sure you want to delete this post?');"
                              style="display:inline" th:action="@{/forum/posts/{postId}/delete(postId=${post.id})}"
                              th:if="${canEdit != null && canEdit && !post.deleted}">
                            <button class="btn btn-danger" type="submit">Delete</button>
                        </form>
                        <form method="post" onsubmit="return confirm('Are you sure you want to restore this post?');"
                              style="display:inline" th:action="@{/forum/posts/{postId}/restore(postId=${post.id})}"
                              th:if="${canEdit != null && canEdit && post.deleted}">
                            <button class="btn btn-primary" type="submit">Restore</button>
                        </form>
                        <form method="post"
                              style="display: inline;"
                              th:action="@{/forum/posts/{postId}/unlike(postId=${post.id})}"
                              th:if="${currentUser != null && post.likedBy.contains(currentUser)}">
                            <button class="btn btn-ghost liked" type="submit">
                                Unlike · <span th:text="${post.likedBy.size()}"></span>
                            </button>
                        </form>
                        <form method="post"
                              style="display: inline;"
                              th:action="@{/forum/posts/{postId}/like(postId=${post.id})}"
                              th:if="${currentUser != null && !post.likedBy.contains(currentUser)}">
                            <button class="btn btn-ghost" type="submit">
                                Like · <span th:text="${post.likedBy.size()}"></span>
                            </button>
                        </form>
                    </div>
                </section>

                <!-- COMMENTS SECTION -->
                <section class="card comment-section">
                    <header class="card-header">
                        <div>
                            <div class="card-title">Comments</div>
                            <div class="card-subtitle"><span th:text="${post.comments.size()}"></span> replies ·
                                sorted by <span th:if="${sortCommentsBy=='date'}">newest</span>
                                <span th:if="${sortCommentsBy=='likes'}">likes</span></div>
                        </div>
                        <div class="folder-toolbar">
                            <div class="folder-toolbar-right">
                                <form method="get" th:action="@{/forum/posts/{id}(id=${post.id})}">
                                    <select class="comment-order-by folder-select"
                                            name="sortCommentsBy"
                                            th:value="${sortCommentsBy}"
                                            onchange="this.form.submit()">
                                        <option value="date">Sort by newest</option>
                                        <option value="likes">Sort by most likes</option>
                                    </select>
                                </form>
                            </div>
                        </div>
                    </header>

                    <!-- COMMENT FORM (visible when logged in) -->
                    <div class="comment-form" sec:authorize="isAuthenticated()">
                        <div class="comment-form-header">
                            <span class="comment-form-avatar" th:text="${#strings.substring(currentUser.username, 0, 1)}">M</span>
                            <div class="comment-form-meta">
                                <div class="comment-form-user" sec:authentication="name">You</div>
                                <div class="comment-form-hint">Share your thoughts about this discussion.</div>
                            </div>
                        </div>
                        <form th:action="@{/forum/posts/{postId}/comments(postId=${post.id})}" method="post">
                            <textarea
                                    class="comment-input"
                                    name="content"
                                    placeholder="Write a comment..."
                                    rows="4"
                                    th:field="*{commentCreationDto.content}"></textarea>
                            <div class="comment-form-actions">
                                <button class="btn btn-primary" type="submit">Post comment</button>
                                <span class="comment-form-note">Markdown supported. Add spoilers with >!
                                    text, **bold** for emphasis, *italic* for emphasis, [text](url) for links.</span>
                            </div>
                        </form>
                        <div th:if="${commentError}" class="alert alert-error" style="margin-top: 0.5rem;">
                            <span th:text="${commentError}"></span>
                        </div>
                    </div>

                    <!-- COMMENT LIST -->
                    <div class="comment-list">
                        <!-- Comment Template -->
                        <article class="comment" th:each="comment : ${comments}">
                            <header class="comment-header">
                                <div class="comment-avatar" th:text="${#strings.substring(comment.user.username, 0, 1)}">A</div>
                                <div class="comment-header-main">
                                    <div class="comment-author-row">
                                        <span class="comment-author" th:text="${comment.user.username}">ana</span>
                                        <span class="comment-badge comment-badge-admin" th:if="${comment.user.role.name() == 'ADMIN'}">Admin</span>
                                        <span class="comment-badge comment-badge-mod" th:if="${comment.user.role.name() == 'MODERATOR'}">Moderator</span>
                                    </div>
                                    <div class="comment-meta">
                                        <span>1 hour ago (TODO)</span>
                                        <span th:if="${comment.createdAt != comment.updatedAt}">·</span>
                                        <span th:if="${comment.createdAt != comment.updatedAt}">Edited (TODO)</span>
                                    </div>
                                </div>
                            </header>
                            <div class="comment-body">
                                <!-- Display existing comment content -->
                                <div th:if="${editingCommentId != comment.id}">
                                    <p th:text="${comment.content}"></p>
                                </div>

                                <!-- Edit form (when editing THIS comment) -->
                                <div th:if="${editingCommentId == comment.id}">
                                    <form th:action="@{/forum/posts/{postId}/comments/{commentId}/edit(postId=${post.id}, commentId=${comment.id})}"
                                          method="post">
                                        <textarea
                                                class="comment-input"
                                                name="content"
                                                rows="3"
                                                style="min-height: 80px; margin-bottom: 0.5rem;"
                                                th:text="${comment.content}"></textarea>
                                        <div class="comment-form-actions" style="margin-top: 0.5rem;">
                                            <button class="btn btn-primary btn-sm" type="submit">Save</button>
                                            <button class="btn btn-ghost btn-sm" type="button"
                                                    onclick="window.location.href='/forum/posts/${post.id}'">Cancel</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <footer class="comment-footer">
                                <!-- Reply -->
                                <button class="comment-action" type="button">Reply</button>

                                <!-- Report -->
                                <button class="comment-action" type="button">Report</button>

                                <!-- Like/Unlike buttons -->
                                <div style="display: inline;">
                                    <form th:if="${currentUser != null && comment.likedBy.contains(currentUser)}"
                                          method="post"
                                          th:action="@{/forum/posts/{postId}/comments/{commentId}/unlike(postId=${post.id}, commentId=${comment.id})}"
                                          style="display: inline;">
                                        <button type="submit" class="comment-action liked" style="color: var(--accent); border-color: var(--accent);">
                                            Unlike · <span th:text="${comment.likedBy.size()}"></span>
                                        </button>
                                    </form>
                                    <form th:if="${currentUser != null && !comment.likedBy.contains(currentUser)}"
                                          method="post"
                                          th:action="@{/forum/posts/{postId}/comments/{commentId}/like(postId=${post.id}, commentId=${comment.id})}"
                                          style="display: inline;">
                                        <button type="submit" class="comment-action">
                                            Like · <span th:text="${comment.likedBy.size()}"></span>
                                        </button>
                                    </form>
                                </div>

                                <!-- Edit Button (only for comment owner or moderator) -->
                                <form th:action="@{/forum/posts/{postId}(postId=${post.id})}"
                                      method="get"
                                      th:if="${currentUser != null && (currentUser.isModerator() || currentUser.id == comment.user.id)}"
                                      style="display: inline;">
                                    <input type="hidden" name="editCommentId" th:value="${comment.id}" />
                                    <button class="comment-action" type="submit">Edit</button>
                                </form>

                                <!-- Delete Button (only for comment owner or moderator) -->
                                <form th:action="@{/forum/posts/{postId}/comments/{commentId}/delete(postId=${post.id}, commentId=${comment.id})}"
                                      method="post"
                                      th:if="${currentUser != null && (currentUser.isModerator() || currentUser.id == comment.user.id)}"
                                      style="display: inline;">
                                    <button class="comment-action comment-action-soft" type="submit"
                                            onclick="return confirm('Are you sure you want to delete this comment?')">
                                        Delete
                                    </button>
                                </form>
                                </button>
                            </footer>
                        </article>
                    </div>
                </section>
            </div>
        </div>
    </main>
</section>
</html>